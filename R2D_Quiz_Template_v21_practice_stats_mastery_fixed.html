 <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- =========================================================
       NOTE (R2D): Page identity
       - Change <title>Template</title>
  <meta name="description" content="Reddi2Drive knowledge test template (UK). Duplicate this file to build new topic tests." />
  

<!-- NOTE (R2D): Home Screen icon (Add to Home Screen)
     iOS uses apple-touch-icon. Android uses manifest icons.
     Add these lines and upload the PNGs to your site:
     <link rel="apple-touch-icon" sizes="180x180" href="icons/reddi2drive-180.png">
     <link rel="manifest" href="manifest.json">
-->
<style>

    /* =========================================================
       STYLES (edit colours, spacing, logo size, etc.)
       ---------------------------------------------------------
       - Most layout is in .card, .btn, .option, and the header.
       - Image sizing rules: .q-image, .q-image.large, .q-image.xlarge
       ========================================================= */


    .q-image{
  display:none;
  width:100%;
  max-width:275px;           /* default image size (desktop) */
  height:auto;
  margin:14px auto 8px;
  border-radius:12px;
}

/* Larger image flags (per-question) */
.q-image.large{ max-width:520px; }
.q-image.xlarge{ max-width:850px; }

/* Mobile / iPad */
@media (max-width: 820px){
  .q-image{ max-width:250px; }
  .q-image.large{ max-width:500px; }
  .q-image.xlarge{ max-width:900px; }
}
@media (max-width: 820px){
    .q-image.xlarge{max-width:750px; }
   }
/* Layout: keep existing button styling, just push Quit to far right */
.r2d-nav-row{
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  margin-top: 6px;   /* ‚Üê drop the buttons down a bit */
}
.r2d-spacer{ flex:1; }


    


    /* =========================================================
       NOTE (R2D): Theme variables (quick way to make each test look unique)
       - Change --bg, --card, --accent, --good, --bad to alter colour scheme.
       - Change --max for layout width.
       ========================================================= */
    :root{
      --bg:#0b1220; --card:#121a2b; --text:#eef3ff; --muted:#9fb0cc;
      --accent:#4aa3ff; --good:#2bd576; --bad:#ff4d4d; --border:rgba(255,255,255,.10);
      --shadow:0 12px 30px rgba(0,0,0,.35); --r:16px; --max:820px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(74,163,255,.18), transparent 55%),
        radial-gradient(1200px 800px at 80% 0%, rgba(43,213,118,.10), transparent 55%),
        var(--bg);
    }
    header{max-width:var(--max); margin:0 auto; padding:22px 16px 8px}
    h1{margin:0; font-size:20px; letter-spacing:.2px}
    main{max-width:var(--max); margin:0 auto; padding:8px 16px 28px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 40%), var(--card);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      border-radius:var(--r);
      padding:18px;
      margin:12px 0;
    }
    .row{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .pill{border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted)}
    .muted{color:var(--muted)}
    .big{font-size:28px; margin:0}
    .btn{
      border-radius:14px; border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text); padding:11px 14px; cursor:pointer; font-weight:700;
    }
    .btn.primary{
      background:linear-gradient(90deg, rgba(74,163,255,.95), rgba(74,163,255,.55));
      border-color:rgba(74,163,255,.55); color:#07101d;
    }
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .tag{display:inline-block; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}
    .progress{height:10px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; border:1px solid var(--border); margin-top:12px}
    .progress > div{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), rgba(74,163,255,.55)); transition:width .25s ease}
    .qTitle{margin:10px 0 12px; font-size:18px}
    .answers{display:grid; gap:10px; margin-top:10px}
    .option{
      text-align:left; width:100%;
      padding:12px 12px; border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text); cursor:pointer;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .option:hover{background:rgba(255,255,255,.06)}
    .option:active{transform:scale(.995)}
    .option.selected{border-color:rgba(74,163,255,.65); background:rgba(74,163,255,.12)}
    .option[disabled]{cursor:not-allowed; opacity:.95}
    .feedback{margin-top:12px; padding:12px; border-radius:14px; border:1px solid var(--border); background:rgba(255,255,255,.03)}
    .feedback.good{border-color:rgba(43,213,118,.35); background:rgba(43,213,118,.08)}
    .feedback.bad{border-color:rgba(255,77,77,.35); background:rgba(255,77,77,.08)}
    .feedback .title{display:flex; justify-content:space-between; gap:10px; align-items:center; font-weight:800; margin-bottom:6px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .small{font-size:12px; color:var(--muted)}
    .kpi{display:flex; gap:12px; flex-wrap:wrap; margin-top:10px}
    .box{flex:1 1 160px; border:1px solid var(--border); background:rgba(255,255,255,.03); border-radius:14px; padding:12px}
    .box .n{font-size:22px; font-weight:900; margin:0}
    .box .l{margin:2px 0 0; color:var(--muted); font-size:12px}
.imgwrap{
  margin:10px auto;
  display:flex;
  justify-content:center;
}
.hint{border-left:3px solid rgba(255,204,102,.7); padding-left:16px; margin-top:10px; color:var(--muted); font-size:13px}
    a{color:var(--accent)}
    .reviewItem{border-top:1px solid var(--border); padding-top:12px; margin-top:12px}
/* --- Review ticks / crosses --- */
#reviewScreen .reviewItem{ position:relative; }
#reviewScreen .reviewItem .result{
  position:absolute;
  top:12px;
  right:12px;
  font-size:22px;
  font-weight:900;
  line-height:1;
  white-space:nowrap;
}
#reviewScreen .reviewItem .result.ok{ color:var(--good); }
#reviewScreen .reviewItem .result.bad{ color:var(--bad); }
#reviewScreen .reviewItem .row{ padding-right:48px; }

    .zoomOverlay{
      position:fixed; inset:0; background:rgba(0,0,0,.75);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:9999;
    }
    .zoomOverlay img{
      max-width:min(980px, 96vw);
      max-height:90vh;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.18);
    }
    .brand{
  margin:0;
  font-size:20px;
  letter-spacing:.2px;
  display:flex;
  align-items:center;
  gap:10px;
}
.brandLogo{
  height:60px;
  width:60px;
  border-radius:60%;
  object-fit:cover;
  display:block;
}


/* --- Scroll + pull-to-refresh protection (iPhone + iPad) --- */
html, body{
  height:100%;
  margin:0;
  overflow:hidden;           /* page itself doesn't scroll */
}
body{
  position:fixed;            /* prevents iPad pull-to-refresh bounce */
  width:100%;
}
#appScroll{
  height: 100%;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: none;
}

/* --- Keep the action buttons reachable when an image is shown --- */
#quizScreen{
  padding-bottom:84px;       /* space for the sticky nav row */
}
.r2d-nav-row{
  position:sticky;
  bottom:0;
  z-index:50;
  background:linear-gradient(180deg, rgba(18,26,43,.75), rgba(18,26,43,1));
  backdrop-filter:saturate(120%) blur(6px);
  border-top:1px solid var(--border);
  padding:10px 0 6px;
  margin-top:12px;
}
  .r2d-tagline{
  width:100%;
  text-align:right;          /* desktop/tablet wide */
  margin:-15px 0 0 16px;   /* closer to title, pushed further right */
  font-weight:800;
  letter-spacing:.08em;
  font-size:.85rem;
  position:relative;
  left:16px;
}
@media (max-width: 1024px){
  /* iPad/iPhone: tagline sits UNDER the title */
  .row.header-row{
    flex-direction:column;
    align-items:flex-start;
    gap:6px;
  }
  .r2d-tagline{
    text-align:center;
    margin:-19px 0 0 12px;  /* closer + pushed further right on small screens */
    left:12px;
  }
}

.r2d-word{ text-transform:none; }
.r2d-word.learn{ color:#e53935; }
.r2d-word.drive{
  color:#111;                 /* your requested ‚Äúblack‚Äù */
  text-shadow:0 0 2px rgba(255,255,255,.65); /* keeps it readable on dark header */
}
.r2d-word.pass{  color:#fff; }

.two{ color:#9aa0a6; }
.dot{ margin:0 1px; color:rgba(255,255,255,.35); }

/* (Remove the old .question img sizing rules ‚Äî q-image handles it) */
.review-image{display:block; margin:10px auto;}

/* --- Quiz UI tweaks --- */
/* Hide the category pill on the quiz screen */
#quizScreen #catTag{ display:none !important; }

/* Submit/Next button colour change */
.btn.next-state{
  background:linear-gradient(90deg, rgba(43,213,118,.95), rgba(43,213,118,.55));
  border-color:rgba(43,213,118,.55);
  color:#07101d;
}



/* --- Quit confirmation modal --- */
.quit-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10000;
  backdrop-filter: blur(3px);
}

.quit-box{
  background:var(--card);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  border-radius:18px;
  padding:22px 20px;
  width:min(320px, 90vw);
  text-align:center;
}

.quit-title{
  font-size:18px;
  font-weight:800;
  margin:0 0 6px;
}

.quit-actions{
  display:flex;
  gap:12px;
  justify-content:center;
  margin-top:16px;
}


/* --- Review Last Attempt button (Start screen only) --- */
#reviewLastWrap{
  position:absolute;
  bottom:16px;
  left:50%;
  transform:translateX(-50%);
  display:none;
  text-align:center;
  z-index:20;
}
#reviewLastBtn{
  padding:8px 12px;
  font-weight:800;
}
#reviewLastMeta{
  font-size:11px;
  color:var(--muted);
  margin-top:4px;
}

</style>
</head>
<body>
  <div id="appScroll">
  <header>
    <div class="row header-row">

      <!-- =========================================================
           NOTE (R2D): Branding
           - Change the logo file name in src="..." (keep image in same folder or update path).
           - Change the on-page title in <span id="testTitleText">Template</span>
           - Tagline text is below (can be edited or removed).
           ========================================================= -->
      <h1 class="brand">
        <!-- NOTE (R2D): Logo file name/path goes here -->
        <a href="https://reddi2drive.co.uk/practice/" class="r2d-logo-link">
  <img src="reddi2drivelogo.png" alt="Reddi2Drive" class="brandLogo">
</a>
        <!-- NOTE (R2D): Change this visible test title text (or let JS set it from TEST_TITLE). -->
        <span id="testTitleText">Template</span>
      </h1>

      <div class="r2d-tagline" aria-label="Reddi2Learn Reddi2Drive Reddi2Pass">
        <span class="r2d-word learn">Reddi<span class="two">2</span>Learn</span>
        <span class="dot">|</span>
        <span class="r2d-word drive">Reddi<span class="two">2</span>Drive</span>
        <span class="dot">|</span>
        <span class="r2d-word pass">Reddi<span class="two">2</span>Pass</span>
      </div>
    </div>
  </header>

  <main>
    <!-- =========================================================
         START SCREEN
         - Update the intro text here for each test if you want.
         - Buttons: Start / Shuffle / Reset Best
         ========================================================= -->

    <section class="card" id="startScreen" style="position:relative; padding-bottom:90px">


<div id="reviewLastWrap">
  <button class="btn ghost" id="reviewLastBtn" type="button">Review Last Attempt</button>
  <div id="reviewLastMeta"></div>
</div>


      <!-- NOTE (R2D): Start screen intro text (edit per topic) -->
      <p class="big">Test Your Knowledge</p>
      <p class="muted">No hints during the test ‚Äî you‚Äôll get your score and full review at the end.</p>

      
      <!-- NOTE (R2D): KPI labels (these are the two boxes on the start screen) -->
<div class="kpi">
  <div class="box">
    <p class="n" id="lastScore">‚Äî</p>
    <p class="l">Last attempt score</p>
  </div>
  <div class="box">
    <p class="n" id="bestScore">‚Äî</p>
    <p class="l">Best score achieved</p>
  </div>
</div>

    

      <!-- NOTE (R2D): Start screen buttons (text + visibility can be changed here) -->
      <div class="actions">
        <button class="btn primary" id="startBtn">Start test</button>
        
        <!-- Question count selector (inline) -->
        <div class="pill" id="qsWrapper" style="display:flex; align-items:center; gap:6px; padding:6px 10px">
          <span class="muted" style="font-size:12px; font-weight:800;">Questions</span>
          <!-- ‚úÖ EDIT ME: Question-count dropdown options
               Change the numbers/options here for each quiz (e.g. 10/25/50/Full).
               Keep value="full" for the Full option (the script uses it). -->
          <select id="qsSelect" class="btn ghost" style="padding:6px 8px; font-weight:800; min-width:86px">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="full">Full</option>
          </select>
          <span class="muted" id="qsHint" style="font-size:12px;"></span>
        </div>
<button class="btn" id="resetBestBtn" title="Clears your saved best score">Reset best</button>
      </div>

      <p class="small" style="margin-top:10px">
        UK guidance: always follow signs/markings and local rules for the topic you‚Äôre testing.
      </p>
    </section>

    <!-- =========================================================
         QUIZ SCREEN
         - Shows question, optional image, answer options.
         - Submit turns into Next after submitting.
         ========================================================= -->


    <!-- =========================================================
         NOTE (R2D): Quiz screen
         - Counter format is in #counter (e.g., 1 / 10).
         - Submit button behaviour is controlled in the script (submit -> next).
         - The Quit modal copy is lower down.
         ========================================================= -->
    <section class="card" id="quizScreen" style="display:none">
      <div class="row">
        <div>
          <span class="tag" id="catTag">Category</span>
          <span class="muted" id="counter">1 / 10</span>
        </div>
        <div class="muted" id="scoreMini">Score: 0</div>
      </div>

      <div class="progress"><div id="bar"></div></div>

      <h2 class="qTitle" id="qText">‚Ä¶</h2>

     <img id="qImage" class="q-image" src="" alt="Question image">
      <p class="small" id="imgHint" style="display:none; margin:8px 2px 0">Tap the image to zoom.</p>

      <div class="answers" id="answers"></div>

      <div class="feedback" id="feedback" style="display:none"></div>

 <div class="nav-buttons r2d-nav-row">
  <button class="btn" id="backBtn">Back</button>
  <button class="btn primary" id="submitBtn">Submit</button>
    <span class="r2d-spacer" aria-hidden="true"></span>
  <button class="btn" id="quitBtn">Quit</button>
</div>
    </section>

    <!-- =========================================================
         RESULTS SCREEN
         - Shows score, percentage, time.
         - Buttons: Try again / Review
         ========================================================= -->


    <!-- NOTE (R2D): Results screen text (edit wording per test) -->
    <section class="card" id="resultsScreen" style="display:none">
      <p class="big" id="resultTitle">Results</p>
      <p class="muted" id="resultSub">‚Ä¶</p>

      <div class="kpi">
        <div class="box">
          <p class="n" id="finalScore">0 / 10</p>
          <p class="l">Score</p>
        </div>
        <div class="box">
          <p class="n" id="finalPercent">0%</p>
          <p class="l">Percentage</p>
        </div>
        <div class="box">
          <p class="n" id="finalTime">‚Äî</p>
          <p class="l">Time</p>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="retryBtn">Try again</button>
        <button class="btn" id="reviewBtn">Review</button>
      </div>

      <p class="small" style="margin-top:10px">
        Tip: Add to Home Screen (Safari ‚Üí Share ‚Üí Add to Home Screen).
      </p>
    </section>

    <!-- =========================================================
         REVIEW SCREEN
         - Shows each question, your answer vs correct, explanation.
         - Filter dropdown: All / Incorrect only
         ========================================================= -->


    <!-- NOTE (R2D): Review screen + filter labels (edit wording here) -->
    <section class="card" id="reviewScreen" style="display:none">
      <p class="big">Review</p>
      <p class="muted">Your choice vs the correct answer, plus the explanation.</p>
      <div class="row" style="margin:12px 0 6px">
        <div class="pill" style="display:flex; align-items:center; gap:10px">
          <label for="reviewFilter" class="muted" style="font-size:12px; margin:0">Show:</label>
          <select id="reviewFilter" class="btn" style="padding:8px 10px; font-weight:800">
            <option value="all">All questions</option>
            <option value="wrong">Incorrect only</option>
          </select>
        </div>
        <div class="muted small" id="reviewCount"></div>
      </div>
      <div id="reviewList"></div>

      <div class="actions">
        <button class="btn primary" id="backToResultsBtn">Back to results</button>
        <button class="btn" id="newAttemptBtn">New attempt</button>
      </div>
    </section>

  <!-- NOTE (R2D): Quit confirmation modal text (edit wording here) -->
  <!-- Quit confirmation modal -->
  <div id="quitConfirm" class="quit-overlay" style="display:none;">
    <div class="quit-box" role="dialog" aria-modal="true" aria-labelledby="quitTitle">
      <p class="quit-title" id="quitTitle">Are you sure?</p>
      <p class="muted">Your current progress will be lost.</p>
      <div class="quit-actions">
        <button class="btn ghost" id="quitNoBtn" type="button">No</button>
        <button class="btn primary" id="quitYesBtn" type="button">Yes, Quit</button>
      </div>
    </div>
  </div>


  <!-- NOTE (R2D): Resume attempt modal text (edit wording here) -->
  <!-- Resume Attempt Modal -->
  <div id="resumeModal" class="quit-overlay" style="display:none;">
    <div class="quit-box" role="dialog" aria-modal="true" aria-labelledby="resumeTitle">
      <p class="quit-title" id="resumeTitle">Resume attempt?</p>
      <p class="muted" id="resumeInfo">‚Ä¶</p>
      <div class="quit-actions">
        <button class="btn ghost" id="resumeFreshBtn" type="button">Start fresh</button>
        <button class="btn primary" id="resumeBtn" type="button">Resume</button>
      </div>
    </div>
  </div>

  </main>

  <div class="zoomOverlay" id="zoomOverlay" aria-hidden="true">
    <img id="zoomImg" alt="Zoomed question visual" />
  </div>

<script>
// =========================================================
// REDDI2DRIVE QUIZ TEMPLATE SCRIPT
// ---------------------------------------------------------
// Sections:
// 0) Test Settings (title, slug, number of questions)
// 1) Question Bank (you replace this for each new test)
// 2) State + helpers (shuffle, storage, UI switching)
// 3) Quiz engine (render, select, submit/next)
// 4) Results + review builder
// 5) iOS/iPad scroll/pull-to-refresh protection
// =========================================================

// =========================================================
// 1) QUESTION BANK (EDIT THIS FOR EACH NEW TEST)
// NOTE (R2D): How to make your question bank unique & traceable
// - Keep IDs unique (you are already using vru-0001 etc.)
// - Each question has fp: "..." (your fingerprint). Keep it, or regenerate it per question.
// - If you add images, put files next to this HTML or update the image path.

// ---------------------------------------------------------
// Each question object supports:
// - id: unique string (use a topic prefix like "tl-01", "sp-02", etc.)
// - category: used for the tag on the quiz + review (optional but recommended)
// - q: the question text
// - choices: array of answer strings (A/B/C/D etc.)
// - correct: index of the correct choice (0-based)
// - explain: explanation shown in the Review screen
// - image: filename of an image in the same folder as this HTML (optional)
// - largeImage / extraLargeImage: set true to increase image size (optional)
//
// TIP: Keep filenames consistent (e.g. "tl-q01.png") and put the images in the same GitHub folder.
// =========================================================
// =========================================================
// =========================================================
// NOTE (R2D): Make this test UNIQUE (critical)
// 1) Change TEST_TITLE and TEST_SLUG below.
//    - TEST_SLUG must be UNIQUE per test or scores/resume data will clash.
// 2) Optionally change QS_PER_ATTEMPT_DEFAULT.
// =========================================================


// =========================================================
// ‚úÖ EDIT ME WHEN MAKING A NEW QUIZ (ONLY 3 PLACES)
// ---------------------------------------------------------
// 1) TITLE
//    - Change TEST_TITLE below (updates the on-page title + browser tab)
//    - Keep TEST_SLUG unique per quiz (so saved scores don't clash)
//
// 2) QUESTIONS
//    - Replace the QUESTION_BANK array with your new questions (same format)
//
// 3) DROPDOWN NUMBERS (start screen)
//    - Edit the <select id="qsSelect"> options in the HTML (10/25/50/Full etc.)
//      You will find it by searching for: id="qsSelect"
//
// Nothing else needs changing to publish a new quiz.
// =========================================================

// 0) TEST SETTINGS (EDIT THESE WHEN YOU COPY THIS TEMPLATE)
// =========================================================
// Keep TEST_SLUG unique per test, or scores/resume data will clash between tests.
const TEST_TITLE = "Template";  // ‚Üê CHANGE THIS (on-page + tab title)
const _titleEl = document.getElementById("testTitleText");
if (_titleEl) _titleEl.textContent = TEST_TITLE;
document.title = `Reddi2Drive ‚Äì ${TEST_TITLE}`;
       // e.g. "Traffic Lights", "Motorways", "Signs & Markings"
const TEST_SLUG  = "template";    // ‚Üê CHANGE THIS (must be unique per quiz)    // e.g. "traffic-lights", "motorways", "signs"
// Number of questions per attempt (cannot exceed QUESTION_BANK length)
const QS_PER_ATTEMPT_DEFAULT = 71;
// =========================================================


// =========================================================
// ‚úÖ EDIT ME: QUESTION BANK
// ---------------------------------------------------------
// Replace everything inside QUESTION_BANK with your new questions.
// Keep the same object keys you already use: id, category, q, choices, correct,
// explain, image, fp
//
// Example format (keep correct as 0-3 index):
// {
//   id: "oru-0001",
//   category: "Other road users",
//   q: "Question text...",
//   choices: ["A","B","C","D"],
//   correct: 2,
//   explain: "Explanation...",
//   image: "",   // or "oru-0001.png"
//   fp: "R2D-ORU-0001-YYYYMMDD-XXXX"
// }
// =========================================================

const QUESTION_BANK = [
{
  id: "template-0001",
  category: "Template ‚Äì Example",
  q: "This is an example question used in the template.",
  choices: [
    "Example answer A",
    "Example answer B",
    "Example answer C",
    "Example answer D"
  ],
  correct: 0,
  explain: "This is an example explanation showing where feedback text goes.",
  image: "",
  fp: "R2D-TEMPLATE-0001"
},
 {
  id: "template-0002",
  category: "Template ‚Äì Example",
  q: "This is an example question used in the template.",
  choices: [
    "Example answer A",
    "Example answer B",
    "Example answer C",
    "Example answer D"
  ],
  correct: 0,
  explain: "This is an example explanation showing where feedback text goes.",
  image: "",
  fp: "R2D-TEMPLATE-0002"
}
];

const el = (id) => document.getElementById(id);
const appScroll = document.getElementById("appScroll");
const startScreen = el("startScreen");
const quizScreen = el("quizScreen");
const resultsScreen = el("resultsScreen");
const reviewScreen = el("reviewScreen");

const startBtn = el("startBtn");
const shuffleBtn = el("shuffleBtn");
const resetBestBtn = el("resetBestBtn");
const bestScore = el("bestScore");
const lastScore = el("lastScore");

const catTag = el("catTag");
const counter = el("counter");
const qText = el("qText");
const answers = el("answers");
const feedback = el("feedback");
const submitBtn = el("submitBtn");
const backBtn = el("backBtn");
const quitBtn = el("quitBtn");

const quitConfirm = el("quitConfirm");
const quitYesBtn = el("quitYesBtn");
const quitNoBtn  = el("quitNoBtn");
const resumeModal = el("resumeModal");
const resumeBtn = el("resumeBtn");
const resumeFreshBtn = el("resumeFreshBtn");
const resumeInfo = el("resumeInfo");

const bar = el("bar");
const scoreMini = el("scoreMini");
scoreMini.style.display = "none";

const qImg = el("qImage");
const imgHint = el("imgHint");
const zoomOverlay = el("zoomOverlay");
const zoomImg = el("zoomImg");

const resultTitle = el("resultTitle");
const resultSub = el("resultSub");
const finalScore = el("finalScore");
const finalPercent = el("finalPercent");
const finalTime = el("finalTime");

const retryBtn = el("retryBtn");
const reviewBtn = el("reviewBtn");

const reviewList = el("reviewList");
const reviewFilter = el("reviewFilter");
const reviewCount = el("reviewCount");
const backToResultsBtn = el("backToResultsBtn");
const newAttemptBtn = el("newAttemptBtn");


// =========================================================
// NOTE (R2D): Local storage keys (scores + resume)
// These depend on TEST_SLUG. If you duplicate this file, update TEST_SLUG.
// =========================================================
const STORAGE_BEST = `r2d_${TEST_SLUG}_best`;
const STORAGE_ATTEMPT = `r2d_${TEST_SLUG}_attempt_v1`;

const STORAGE_LAST_REVIEW = `r2d_${TEST_SLUG}_last_review`;
const STORAGE_QS = `r2d_${TEST_SLUG}_qs`;

// =========================================================
// R2D PRACTICE DASHBOARD STATS + MASTERY (TEMPLATE)
// ---------------------------------------------------------
// This writes progress into localStorage so your Practice page can show:
// - Best / Last / Attempts (%)
// - Mastered (unique questions ever answered correctly)
// Keys are derived from TEST_SLUG (keep TEST_SLUG unique per test).
// =========================================================
const R2D_PRACTICE_STATS_KEY        = `r2d_${TEST_SLUG.replace(/-/g,"_")}`;  // e.g. r2d_staying_alert                 // e.g. r2d_staying_alert
const R2D_MASTERY_STATS_KEY         = `r2d_${TEST_SLUG}_mastery_stats_v1`;  // e.g. r2d_staying-alert_mastery_stats_v1 // e.g. r2d_staying-alert_mastery_stats_v1
const R2D_MASTERY_MAP_KEY           = `r2d_${TEST_SLUG}_mastery_map_v1`;    // e.g. r2d_staying-alert_mastery_map_v1   // e.g. r2d_staying-alert_mastery_map_v1

function r2dSavePracticeStats(storageKey, score, total){
  try{
    const existing = JSON.parse(localStorage.getItem(storageKey)) || { best: "0%", attempts: 0 };
    const percent = Math.round((score / total) * 100);

    const bestNum = parseInt(String(existing.best || "0").replace("%",""), 10);
    const safeBest = Number.isFinite(bestNum) ? bestNum : 0;

    const updated = {
      last: percent + "%",
      best: Math.max(safeBest, percent) + "%",
      attempts: (existing.attempts || 0) + 1
    };

    localStorage.setItem(storageKey, JSON.stringify(updated));
  }catch(e){}
}

function r2dLoadMasteryMap(mapKey){
  try{
    const raw = localStorage.getItem(mapKey);
    const obj = raw ? JSON.parse(raw) : {};
    return (obj && typeof obj === "object") ? obj : {};
  }catch{
    return {};
  }
}

function r2dSaveMasteryFromAttempt(){
  // Mark any correctly-answered questions as "mastered"
  const map = r2dLoadMasteryMap(R2D_MASTERY_MAP_KEY);

  for (let i = 0; i < attempt.length; i++){
    const p = picked[i];
    if (!p) continue;
    if (p.choiceIndex === attempt[i].correct){
      const qid = attempt[i].id;
      if (qid) map[qid] = true;
    }
  }

  // Count mastered across the FULL bank (not just this attempt)
  const total = QUESTION_BANK.length;
  let mastered = 0;
  for (const q of QUESTION_BANK){
    if (q && q.id && map[q.id]) mastered++;
  }

  localStorage.setItem(R2D_MASTERY_MAP_KEY, JSON.stringify(map));
  localStorage.setItem(R2D_MASTERY_STATS_KEY, JSON.stringify({
    mastered,
    total,
    updatedAt: Date.now()
  }));
}


function saveLastReview(){
  try{
    localStorage.setItem(STORAGE_LAST_REVIEW, JSON.stringify({
      savedAt: Date.now(),
      attempt,
      picked
    }));
  }catch(e){}
}

function loadLastReview(){
  try{
    const raw = localStorage.getItem(STORAGE_LAST_REVIEW);
    if (!raw) return null;
    const s = JSON.parse(raw);
    if (!s || !Array.isArray(s.attempt) || !Array.isArray(s.picked)) return null;
    return s;
  }catch{
    return null;
  }
}

function showLastReviewButton(){
  const wrap = document.getElementById("reviewLastWrap");
  const meta = document.getElementById("reviewLastMeta");
  const btn  = document.getElementById("reviewLastBtn");
  if (!wrap || !btn) return;

  const s = loadLastReview();
  if (!s){
    wrap.style.display = "none";
    return;
  }

  if (meta) meta.textContent = new Date(s.savedAt).toLocaleString();
  wrap.style.display = "block";

  btn.onclick = () => {
    attempt = s.attempt;
    picked  = s.picked;
    buildReview("all");
    show(reviewScreen);
  };
}

let attempt = [];
let idx = 0;
let score = 0;
let picked = [];
let currentSelected = null;
let startedAt = null;
let qsPerAttempt = QS_PER_ATTEMPT_DEFAULT;

let submitMode = 'submit'; // 'submit' or 'next'


function setSubmitButton(mode){
  submitMode = mode;
  if (mode === 'submit'){
    submitBtn.textContent = 'Submit';
    submitBtn.classList.add('primary');
    submitBtn.classList.remove('next-state');
  } else {
    submitBtn.textContent = 'Next';
    submitBtn.classList.remove('primary');
    submitBtn.classList.add('next-state');
  }
}


function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}
function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function saveAttempt(){
  try{
    const state = {
      v: 1,
      savedAt: Date.now(),
      idx,
      score,
      picked,
      attempt,
      startedAt: startedAt ? new Date(startedAt).toISOString() : null
    };
    localStorage.setItem(STORAGE_ATTEMPT, JSON.stringify(state));
  }catch(e){
    console.warn("Could not save attempt", e);
  }
}

function loadAttempt(){
  try{
    const raw = localStorage.getItem(STORAGE_ATTEMPT);
    if (!raw) return null;
    const state = JSON.parse(raw);
    if (!state || state.v !== 1) return null;
    return state;
  }catch{
    return null;
  }
}

function clearAttempt(){
  localStorage.removeItem(STORAGE_ATTEMPT);
}

function checkForResume(){
  const state = loadAttempt();
  if (!state || !Array.isArray(state.attempt) || typeof state.idx !== "number") return false;
  if (state.idx < 0 || state.idx >= state.attempt.length) return false;

  // If it's basically a fresh attempt with no answers, only prompt if they've actually started
  const hasProgress = Array.isArray(state.picked) && state.picked.some(p => p !== null && p !== undefined);
  if (!hasProgress) return false;

  const minsAgo = Math.max(0, Math.round((Date.now() - (state.savedAt || Date.now())) / 60000));
  if (resumeInfo){
    resumeInfo.textContent = `You were on question ${state.idx + 1}. Saved ${minsAgo === 0 ? "just now" : minsAgo + " min ago"}.`;
  }
  if (resumeModal) resumeModal.style.display = "flex";
  return true;
}

if (resumeBtn){
  resumeBtn.addEventListener("click", () => {
    const state = loadAttempt();
    if (!state) return;
    // restore state
    attempt = state.attempt;
    idx = state.idx;
    score = state.score || 0;
    picked = Array.isArray(state.picked) ? state.picked : Array(attempt.length).fill(null);
    startedAt = state.startedAt ? new Date(state.startedAt) : new Date();

    if (resumeModal) resumeModal.style.display = "none";
    show(quizScreen);
    render();
  });
}

if (resumeFreshBtn){
  resumeFreshBtn.addEventListener("click", () => {
    clearAttempt();
    if (resumeModal) resumeModal.style.display = "none";
    loadStats();
    buildAttempt();
    show(quizScreen);
    render();
  });
}

// Tap outside the box closes (does not clear anything)
if (resumeModal){
  resumeModal.addEventListener("click", (e) => {
    if (e.target === resumeModal) resumeModal.style.display = "none";
  });
}
function show(screen){
  startScreen.style.display="none";
  quizScreen.style.display="none";
  resultsScreen.style.display="none";
  reviewScreen.style.display="none";
  screen.style.display="block";
  if (appScroll) appScroll.scrollTo({top:0, behavior:"smooth"});
}
function loadStats(){
  // Load saved question count (or default) and clamp to bank size
  const saved = localStorage.getItem(STORAGE_QS);
  let desired = saved ? Number(saved) : QS_PER_ATTEMPT_DEFAULT;
  if (!Number.isFinite(desired) || desired < 1) desired = QS_PER_ATTEMPT_DEFAULT;

  qsPerAttempt = Math.min(desired, QUESTION_BANK.length);

  const best = Number(localStorage.getItem(STORAGE_BEST) || 0);
  const last = Number(localStorage.getItem(`r2d_${TEST_SLUG}_last`) || 0);

  bestScore.textContent = best ? `${best} / ${qsPerAttempt}` : "‚Äî";
  lastScore.textContent = last ? `${last} / ${qsPerAttempt}` : "‚Äî";

  // Sync dropdown UI (start screen)
  const qsSelect = document.getElementById("qsSelect");
  const qsHint   = document.getElementById("qsHint");
  if (qsSelect){
    const full = QUESTION_BANK.length;
    const fullOpt = qsSelect.querySelector('option[value="full"]');
    if (fullOpt) fullOpt.textContent = `Full (${full})`;
    qsSelect.value = (qsPerAttempt === full) ? "full" : String(qsPerAttempt);
  }
  if (qsHint){
    qsHint.textContent = `(${qsPerAttempt} per attempt)`;
  }
}

function buildAttempt(){
  qsPerAttempt = Math.min(qsPerAttempt, QUESTION_BANK.length);
  const pool = shuffle(QUESTION_BANK);
  const selected = pool.slice(0, qsPerAttempt).map(q => {
    const mapped = q.choices.map((text, i) => ({text, originalIndex:i}));
    const shuffled = shuffle(mapped);
    const newCorrect = shuffled.findIndex(x => x.originalIndex === q.correct);
    return {...q, choices: shuffled.map(x => x.text), correct: newCorrect};
  });

  attempt = selected;
  idx = 0;
  score = 0;
  picked = Array(attempt.length).fill(null);
  startedAt = new Date();
  saveAttempt();
}
function setImage(src, isLarge, isXLarge){
  // reset sizing class each time
  qImg.className = "q-image" + (isLarge ? " large" : "") + (isXLarge ? " xlarge" : "");
  if (!src){
    qImg.style.display = "none";
    imgHint.style.display = "none";
    qImg.removeAttribute("src");
    return;
  }
  qImg.style.display = "block";
  imgHint.style.display = "block";
  qImg.src = src;
}


qImg.addEventListener("click", () => {
  if (!qImg.getAttribute("src")) return;
  zoomImg.src = qImg.src;
  zoomOverlay.style.display = "flex";
  zoomOverlay.setAttribute("aria-hidden","false");
});
zoomOverlay.addEventListener("click", () => {
  zoomOverlay.style.display = "none";
  zoomOverlay.setAttribute("aria-hidden","true");
  zoomImg.removeAttribute("src");
});

function render(){
  const q = attempt[idx];
  catTag.textContent = q.category || "Category";
  counter.textContent = `Question ${idx+1}`;
  qText.textContent = q.q;

  // Hide running score so users don't know results until the end
  scoreMini.textContent = "";

  // Progress shows where you are in the quiz (not your score)
  bar.style.width = `${Math.round((idx/attempt.length)*100)}%`;

  const isLarge = !!(q.largeImage ?? q.largeimage);
  const isXLarge = !!(q.extraLargeImage ?? q.extraLargeimage ?? q.xlargeImage ?? q.xlargeimage);
  setImage(q.image, isLarge, isXLarge);

  answers.innerHTML = "";
  feedback.style.display = "none"; // no per-question feedback
  feedback.className = "feedback";

  currentSelected = null;
  setSubmitButton('submit');
  submitBtn.disabled = true;

  q.choices.forEach((choiceText, i) => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "option";
    b.textContent = choiceText;
    b.addEventListener("click", () => selectOption(i));
    answers.appendChild(b);
  });

  // If this question was already submitted (e.g. user pressed Back), show it locked
  if (picked[idx] !== null && picked[idx] !== undefined){
    const chosen = picked[idx].choiceIndex;
    lockSubmitted(chosen);
    setSubmitButton('next');
    submitBtn.disabled = false;
    bar.style.width = `${Math.round(((idx+1)/attempt.length)*100)}%`;
  }
}

function selectOption(selectedIndex){
  // allow changing mind until submitted
  if (picked[idx] !== null && picked[idx] !== undefined) return;

  currentSelected = selectedIndex;
  submitBtn.disabled = false;

  [...answers.querySelectorAll("button.option")].forEach((btn, i) => {
    btn.classList.toggle("selected", i === selectedIndex);
  });
}

function lockSubmitted(selectedIndex){
  [...answers.querySelectorAll("button.option")].forEach((btn, i) => {
    btn.disabled = true;
    btn.classList.toggle("selected", i === selectedIndex);
  });
}

function submitCurrent(){
  if (currentSelected === null) return;

  // lock in answer for this question
  picked[idx] = { choiceIndex: currentSelected };

  lockSubmitted(currentSelected);
  setSubmitButton('next');
  submitBtn.disabled = false;
  bar.style.width = `${Math.round(((idx+1)/attempt.length)*100)}%`;
  saveAttempt();
}

function finish(){
  const total = attempt.length;

  // Calculate score only at the end (no feedback during the quiz)
  score = picked.reduce((s, p, i) => {
    if (!p) return s;
    return s + (p.choiceIndex === attempt[i].correct ? 1 : 0);
  }, 0);

  const pct = Math.round((score/total)*100);
  const elapsedMs = new Date() - startedAt;
  const mins = Math.floor(elapsedMs/60000);
  const secs = Math.floor((elapsedMs%60000)/1000);
  const timeStr = `${mins}m ${secs}s`;

  finalScore.textContent = `${score} / ${total}`;
  finalPercent.textContent = `${pct}%`;
  finalTime.textContent = timeStr;

  let title, sub;
  if (pct >= 90){
    title = "Excellent knowledge üí™";
    sub = "Keep it sharp by practising in real situations and revisiting any tricky areas.";
  } else if (pct >= 70){
    title = "Good work ‚Äî a few gaps to tighten up ‚úÖ";
    sub = "Review the questions you missed and focus on the rules that caught you out.";
  } else if (pct >= 50){
    title = "Not bad ‚Äî let‚Äôs build consistency üîÅ";
    sub = "Slow down, read each question carefully, and learn the patterns behind the correct answers.";
  } else {
    title = "Let‚Äôs nail the foundations üß±";
    sub = "Use the review explanations, then try again. Consistency beats guessing.";
  }
  resultTitle.textContent = title;
  resultSub.textContent = sub;

localStorage.setItem(`r2d_${TEST_SLUG}_last`, String(score));
  
  const best = Number(localStorage.getItem(STORAGE_BEST) || 0);
  if (score > best){
    localStorage.setItem(STORAGE_BEST, String(score));
  }

  // ---- Practice dashboard stats + mastery ----
  try{
    r2dSavePracticeStats(R2D_PRACTICE_STATS_KEY, score, total);
    r2dSaveMasteryFromAttempt();
  }catch(e){
    console.warn("R2D practice tracking failed", e);
  }

  loadStats();

  saveLastReview();

  clearAttempt();

    show(resultsScreen);
}

function buildReview(filter = 'all'){
  reviewList.innerHTML = "";
  let shown = 0;

  attempt.forEach((q, i) => {
    const p = picked[i];
    const you = p ? q.choices[p.choiceIndex] : "‚Äî";
    const correct = q.choices[q.correct];
    const ok = p ? (p.choiceIndex === q.correct) : false;

    if (filter === "wrong" && ok) return;

    shown += 1;

    const div = document.createElement("div");
    div.className = "reviewItem";
    div.innerHTML = `
      <div class="row">
        <div>
          <strong>${escapeHtml(q.q)}</strong>
        </div>
        <div class="result ${ok ? "ok" : "bad"}">${ok ? "‚úì" : "‚úï"}</div>
      </div>
      ${q.image ? `<img class="q-image review-image${q.largeImage ? " large" : ""}${q.extraLargeImage ? " xlarge" : ""}" alt="Question visual" src="${escapeHtml(q.image)}">` : ""}
      <div class="small" style="margin-top:8px">
        <div><span class="muted">You chose:</span> <strong>${escapeHtml(you)}</strong></div>
        <div><span class="muted">Correct:</span> <strong>${escapeHtml(correct)}</strong></div>
      </div>
      <div class="hint">${escapeHtml(q.explain || "")}</div>
    `;
    reviewList.appendChild(div);
  });

  if (reviewCount) reviewCount.textContent = `${shown} shown`;
}

startBtn.addEventListener("click", () => {
  loadStats();
  if (checkForResume()) return;
  buildAttempt();
  show(quizScreen);
  render();
});
resetBestBtn.addEventListener("click", () => {
  localStorage.removeItem(STORAGE_BEST);
  loadStats();
});


function goNext(){
  // must submit before moving on
  if (!picked[idx]) return;

  if (idx < attempt.length - 1){
    idx += 1;
    saveAttempt();
    render();
  } else {
    finish();
  }
}

submitBtn.addEventListener("click", () => {
  if (submitMode === "submit"){
    submitCurrent();
  } else {
    goNext();
  }
});

backBtn.addEventListener("click", () => {
  if (idx > 0){
    idx -= 1;
    render();
  } else {
    show(startScreen);
    showLastReviewButton();
  }
});
quitBtn.addEventListener("click", () => {
  if (!quitConfirm) { show(startScreen); showLastReviewButton(); return; }
  quitConfirm.style.display = "flex";
});

if (quitNoBtn){
  quitNoBtn.addEventListener("click", () => {
    quitConfirm.style.display = "none";
  });
}

if (quitYesBtn){
  quitYesBtn.addEventListener("click", () => {
    quitConfirm.style.display = "none";
    clearAttempt();
    window.location.href = "https://reddi2drive.co.uk/practice/";
  });
}

// Tap outside the box closes (same as "No")
if (quitConfirm){
  quitConfirm.addEventListener("click", (e) => {
    if (e.target === quitConfirm) quitConfirm.style.display = "none";
  });
}

retryBtn.addEventListener("click", () => {
  buildAttempt();
  show(quizScreen);
  render();
});
reviewBtn.addEventListener("click", () => {
  const f = reviewFilter ? reviewFilter.value : "all";
  buildReview(f);
  show(reviewScreen);
});

if (reviewFilter){
  reviewFilter.addEventListener("change", () => buildReview(reviewFilter.value));
}
backToResultsBtn.addEventListener("click", () => show(resultsScreen));
newAttemptBtn.addEventListener("click", () => {
  buildAttempt();
  show(quizScreen);
  render();
});

// =========================================================
// 2) UI TITLE (AUTO)
// ---------------------------------------------------------
// Keeps the page header title in sync with TEST_TITLE.
// =========================================================
const titleEl = document.getElementById("testTitleText");
if (titleEl) titleEl.textContent = TEST_TITLE;

loadStats();
show(startScreen);
showLastReviewButton();
checkForResume();

(() => {
  const scroller = document.getElementById("appScroll");
  if (!scroller) return;

  let startY = 0;

  scroller.addEventListener("touchstart", (e) => {
    startY = e.touches[0].clientY;
  }, { passive: true });

  scroller.addEventListener("touchmove", (e) => {
    const y = e.touches[0].clientY;
    const pullingDown = y > startY;

    if (scroller.scrollTop <= 0 && pullingDown) {
      e.preventDefault();
    }
  }, { passive: false });
})();

  // --- Fix iPad landscape viewport + prevent pull-to-refresh reliably ---
(() => {
  const scroller = document.getElementById("appScroll");
  if (!scroller) return;

  function setScrollerHeight(){
    const h = (window.visualViewport && window.visualViewport.height)
      ? Math.round(window.visualViewport.height)
      : window.innerHeight;
    scroller.style.height = h + "px";
  }

  setScrollerHeight();
  window.addEventListener("resize", setScrollerHeight);
  if (window.visualViewport) window.visualViewport.addEventListener("resize", setScrollerHeight);

  let startY = 0;
  scroller.addEventListener("touchstart", (e) => {
    startY = e.touches[0].clientY;
  }, { passive: true });

  scroller.addEventListener("touchmove", (e) => {
    const y = e.touches[0].clientY;
    const pullingDown = y > startY;
    if (scroller.scrollTop <= 0 && pullingDown) e.preventDefault();
  }, { passive: false });
})();


// --- Question count dropdown wiring (Start screen) ---
(function(){
  const qsSelect = document.getElementById("qsSelect");
  const qsHint   = document.getElementById("qsHint");
  if (!qsSelect) return;

  const full = QUESTION_BANK.length;

  const fullOpt = qsSelect.querySelector('option[value="full"]');
  if (fullOpt) fullOpt.textContent = `Full (${full})`;

  // Initialise from storage/default (loadStats also does this, but we keep it robust)
  const saved = localStorage.getItem(STORAGE_QS);
  let desired = saved ? Number(saved) : QS_PER_ATTEMPT_DEFAULT;
  if (!Number.isFinite(desired) || desired < 1) desired = QS_PER_ATTEMPT_DEFAULT;

  qsPerAttempt = Math.min(desired, full);
  qsSelect.value = (qsPerAttempt === full) ? "full" : String(qsPerAttempt);
  if (qsHint) qsHint.textContent = `(${qsPerAttempt} per attempt)`;

  qsSelect.addEventListener("change", () => {
    const v = (qsSelect.value === "full") ? full : Number(qsSelect.value);
    if (!Number.isFinite(v)) return;
    qsPerAttempt = Math.min(v, full);
    localStorage.setItem(STORAGE_QS, String(qsPerAttempt));
    if (qsHint) qsHint.textContent = `(${qsPerAttempt} per attempt)`;
    if (typeof loadStats === "function") loadStats();
  });
})();

// --- Hide question selector once the test starts; show it again for new attempts ---
(function(){
  const qsWrap = document.getElementById("qsWrapper");
  if (!qsWrap) return;

  const startBtn = document.getElementById("startBtn");
  const retryBtn = document.getElementById("retryBtn");
  const newAttemptBtn = document.getElementById("newAttemptBtn");

  function hideQS(){ qsWrap.style.display = "none"; }
  function showQS(){ qsWrap.style.display = "flex"; }

  if (startBtn) startBtn.addEventListener("click", hideQS);
  if (retryBtn) retryBtn.addEventListener("click", showQS);
  if (newAttemptBtn) newAttemptBtn.addEventListener("click", showQS);
})();
</script>
  </div>
</body>
</html>
