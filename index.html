 <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reddi2Drive ‚Äì Test Template</title>
  <meta name="description" content="Reddi2Drive knowledge test template (UK). Duplicate this file to build new topic tests." />
  <style>

    /* =========================================================
       STYLES (edit colours, spacing, logo size, etc.)
       ---------------------------------------------------------
       - Most layout is in .card, .btn, .option, and the header.
       - Image sizing rules: .q-image, .q-image.large, .q-image.xlarge
       ========================================================= */


    .q-image{
  display:none;
  width:100%;
  max-width:160px;           /* visual size control */
  height:auto;
  margin:14px auto 8px;
  border-radius:12px;
}
   .q-image.large{
  max-width:300px;
}
.q-image.xlarge {
 max-width:750px;
}
@media (max-width:820px){
  .q-image.large{
    max-width:450px;
  }
}  

 @media (max-width: 820px){
  .q-image{ max-width:450px; }
}

   @media (max-width: 820px){
    .q-image.xlarge{max-width:750px; }
   }
/* Layout: keep existing button styling, just push Quit to far right */
.r2d-nav-row{
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  margin-top: 6px;   /* ‚Üê drop the buttons down a bit */
}
.r2d-spacer{ flex:1; }


    
    :root{
      --bg:#0b1220; --card:#121a2b; --text:#eef3ff; --muted:#9fb0cc;
      --accent:#4aa3ff; --good:#2bd576; --bad:#ff4d4d; --border:rgba(255,255,255,.10);
      --shadow:0 12px 30px rgba(0,0,0,.35); --r:16px; --max:820px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(74,163,255,.18), transparent 55%),
        radial-gradient(1200px 800px at 80% 0%, rgba(43,213,118,.10), transparent 55%),
        var(--bg);
    }
    header{max-width:var(--max); margin:0 auto; padding:22px 16px 8px}
    h1{margin:0; font-size:20px; letter-spacing:.2px}
    main{max-width:var(--max); margin:0 auto; padding:8px 16px 28px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 40%), var(--card);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      border-radius:var(--r);
      padding:18px;
      margin:12px 0;
    }
    .row{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .pill{border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted)}
    .muted{color:var(--muted)}
    .big{font-size:28px; margin:0}
    .btn{
      border-radius:14px; border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text); padding:11px 14px; cursor:pointer; font-weight:700;
    }
    .btn.primary{
      background:linear-gradient(90deg, rgba(74,163,255,.95), rgba(74,163,255,.55));
      border-color:rgba(74,163,255,.55); color:#07101d;
    }
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .tag{display:inline-block; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}
    .progress{height:10px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; border:1px solid var(--border); margin-top:12px}
    .progress > div{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), rgba(74,163,255,.55)); transition:width .25s ease}
    .qTitle{margin:10px 0 12px; font-size:18px}
    .answers{display:grid; gap:10px; margin-top:10px}
    .option{
      text-align:left; width:100%;
      padding:12px 12px; border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text); cursor:pointer;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .option:hover{background:rgba(255,255,255,.06)}
    .option:active{transform:scale(.995)}
    .option.selected{border-color:rgba(74,163,255,.65); background:rgba(74,163,255,.12)}
    .option[disabled]{cursor:not-allowed; opacity:.95}
    .feedback{margin-top:12px; padding:12px; border-radius:14px; border:1px solid var(--border); background:rgba(255,255,255,.03)}
    .feedback.good{border-color:rgba(43,213,118,.35); background:rgba(43,213,118,.08)}
    .feedback.bad{border-color:rgba(255,77,77,.35); background:rgba(255,77,77,.08)}
    .feedback .title{display:flex; justify-content:space-between; gap:10px; align-items:center; font-weight:800; margin-bottom:6px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .small{font-size:12px; color:var(--muted)}
    .kpi{display:flex; gap:12px; flex-wrap:wrap; margin-top:10px}
    .box{flex:1 1 160px; border:1px solid var(--border); background:rgba(255,255,255,.03); border-radius:14px; padding:12px}
    .box .n{font-size:22px; font-weight:900; margin:0}
    .box .l{margin:2px 0 0; color:var(--muted); font-size:12px}
.imgwrap{
  margin:10px auto;
  display:flex;
  justify-content:center;
}
.hint{border-left:3px solid rgba(255,204,102,.7); padding-left:16px; margin-top:10px; color:var(--muted); font-size:13px}
    a{color:var(--accent)}
    .reviewItem{border-top:1px solid var(--border); padding-top:12px; margin-top:12px}
    .zoomOverlay{
      position:fixed; inset:0; background:rgba(0,0,0,.75);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:9999;
    }
    .zoomOverlay img{
      max-width:min(980px, 96vw);
      max-height:90vh;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.18);
    }
    .brand{
  margin:0;
  font-size:20px;
  letter-spacing:.2px;
  display:flex;
  align-items:center;
  gap:10px;
}
.brandLogo{
  height:60px;
  width:60px;
  border-radius:60%;
  object-fit:cover;
  display:block;
}


/* --- Scroll + pull-to-refresh protection (iPhone + iPad) --- */
html, body{
  height:100%;
  margin:0;
  overflow:hidden;           /* page itself doesn't scroll */
}
body{
  position:fixed;            /* prevents iPad pull-to-refresh bounce */
  width:100%;
}
#appScroll{
  height: 100%;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: none;
}

/* --- Keep the action buttons reachable when an image is shown --- */
#quizScreen{
  padding-bottom:84px;       /* space for the sticky nav row */
}
.r2d-nav-row{
  position:sticky;
  bottom:0;
  z-index:50;
  background:linear-gradient(180deg, rgba(18,26,43,.75), rgba(18,26,43,1));
  backdrop-filter:saturate(120%) blur(6px);
  border-top:1px solid var(--border);
  padding:10px 0 6px;
  margin-top:12px;
}
  .r2d-tagline{
  width:100%;
  text-align:right;          /* desktop/tablet wide */
  margin:-15px 0 0 16px;   /* closer to title, pushed further right */
  font-weight:800;
  letter-spacing:.08em;
  font-size:.85rem;
  position:relative;
  left:16px;
}
@media (max-width: 1024px){
  /* iPad/iPhone: tagline sits UNDER the title */
  .row.header-row{
    flex-direction:column;
    align-items:flex-start;
    gap:6px;
  }
  .r2d-tagline{
    text-align:center;
    margin:-19px 0 0 12px;  /* closer + pushed further right on small screens */
    left:12px;
  }
}

.r2d-word{ text-transform:none; }
.r2d-word.learn{ color:#e53935; }
.r2d-word.drive{
  color:#111;                 /* your requested ‚Äúblack‚Äù */
  text-shadow:0 0 2px rgba(255,255,255,.65); /* keeps it readable on dark header */
}
.r2d-word.pass{  color:#fff; }

.two{ color:#9aa0a6; }
.dot{ margin:0 1px; color:rgba(255,255,255,.35); }

/* (Remove the old .question img sizing rules ‚Äî q-image handles it) */
.review-image{display:block; margin:10px auto;}

/* --- Quiz UI tweaks --- */
/* Hide the category pill on the quiz screen */
#quizScreen #catTag{ display:none !important; }

/* Submit/Next button colour change */
.btn.next-state{
  background:linear-gradient(90deg, rgba(43,213,118,.95), rgba(43,213,118,.55));
  border-color:rgba(43,213,118,.55);
  color:#07101d;
}



/* --- Quit confirmation modal --- */
.quit-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10000;
  backdrop-filter: blur(3px);
}

.quit-box{
  background:var(--card);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  border-radius:18px;
  padding:22px 20px;
  width:min(320px, 90vw);
  text-align:center;
}

.quit-title{
  font-size:18px;
  font-weight:800;
  margin:0 0 6px;
}

.quit-actions{
  display:flex;
  gap:12px;
  justify-content:center;
  margin-top:16px;
}


/* --- Review result icons pinned top-right (no overlap) --- */
#reviewScreen .reviewItem{ position:relative; }
#reviewScreen .reviewItem .result{
  position:absolute;
  top:12px;
  right:12px;
  font-size:22px;
  line-height:1;
  white-space:nowrap;
}
#reviewScreen .reviewItem .result.ok{ color: var(--good); }
#reviewScreen .reviewItem .result.bad{ color: var(--bad); }
/* reserve space so long titles never sit under the icon */
#reviewScreen .reviewItem .row{ padding-right:48px; }
#reviewScreen .reviewItem .row strong{ display:block; }

</style>
</head>
<body>
  <div id="appScroll">
  <header>
    <div class="row header-row">
      <h1 class="brand">
        <img src="reddi2drivelogo.png" alt="Reddi2Drive" class="brandLogo">
        <span id="testTitleText">Road Signs</span>
      </h1>

      <div class="r2d-tagline" aria-label="Reddi2Learn Reddi2Drive Reddi2Pass">
        <span class="r2d-word learn">Reddi<span class="two">2</span>Learn</span>
        <span class="dot">|</span>
        <span class="r2d-word drive">Reddi<span class="two">2</span>Drive</span>
        <span class="dot">|</span>
        <span class="r2d-word pass">Reddi<span class="two">2</span>Pass</span>
      </div>
    </div>
  </header>

  <main>
    <!-- =========================================================
         START SCREEN
         - Update the intro text here for each test if you want.
         - Buttons: Start / Shuffle / Reset Best
         ========================================================= -->

    <section class="card" id="startScreen">
      <p class="big">Test Your Knowledge</p>
      <p class="muted">No hints during the test ‚Äî you‚Äôll get your score and full review at the end.</p>

      <div class="kpi">
  <div class="box">
    <p class="n" id="lastScore">‚Äî</p>
    <p class="l">Last attempt score</p>
  </div>
  <div class="box">
    <p class="n" id="bestScore">‚Äî</p>
    <p class="l">Best score achieved</p>
  </div>
</div>

    
      <div class="actions">
        <button class="btn primary" id="startBtn">Start test</button>
        <button class="btn ghost" id="shuffleBtn" title="Shuffle the bank order">Shuffle bank</button>
        <button class="btn" id="resetBestBtn" title="Clears your saved best score">Reset best</button>
      </div>

      <p class="small" style="margin-top:10px">
        UK guidance: always follow signs/markings and local rules for the topic you‚Äôre testing.
      </p>
    </section>

    <!-- =========================================================
         QUIZ SCREEN
         - Shows question, optional image, answer options.
         - Submit turns into Next after submitting.
         ========================================================= -->

    <section class="card" id="quizScreen" style="display:none">
      <div class="row">
        <div>
          <span class="tag" id="catTag">Category</span>
          <span class="muted" id="counter">1 / 10</span>
        </div>
        <div class="muted" id="scoreMini">Score: 0</div>
      </div>

      <div class="progress"><div id="bar"></div></div>

      <h2 class="qTitle" id="qText">‚Ä¶</h2>

     <img id="qImage" class="q-image" src="" alt="Question image">
      <p class="small" id="imgHint" style="display:none; margin:8px 2px 0">Tap the image to zoom.</p>

      <div class="answers" id="answers"></div>

      <div class="feedback" id="feedback" style="display:none"></div>

 <div class="nav-buttons r2d-nav-row">
  <button class="btn" id="backBtn">Back</button>
  <button class="btn primary" id="submitBtn">Submit</button>
    <span class="r2d-spacer" aria-hidden="true"></span>
  <button class="btn" id="quitBtn">Quit</button>
</div>
    </section>

    <!-- =========================================================
         RESULTS SCREEN
         - Shows score, percentage, time.
         - Buttons: Try again / Review
         ========================================================= -->

    <section class="card" id="resultsScreen" style="display:none">
      <p class="big" id="resultTitle">Results</p>
      <p class="muted" id="resultSub">‚Ä¶</p>

      <div class="kpi">
        <div class="box">
          <p class="n" id="finalScore">0 / 10</p>
          <p class="l">Score</p>
        </div>
        <div class="box">
          <p class="n" id="finalPercent">0%</p>
          <p class="l">Percentage</p>
        </div>
        <div class="box">
          <p class="n" id="finalTime">‚Äî</p>
          <p class="l">Time</p>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="retryBtn">Try again</button>
        <button class="btn" id="reviewBtn">Review</button>
      </div>

      <p class="small" style="margin-top:10px">
        Tip: Add to Home Screen (Safari ‚Üí Share ‚Üí Add to Home Screen).
      </p>
    </section>

    <!-- =========================================================
         REVIEW SCREEN
         - Shows each question, your answer vs correct, explanation.
         - Filter dropdown: All / Incorrect only
         ========================================================= -->

    <section class="card" id="reviewScreen" style="display:none">
      <p class="big">Review</p>
      <p class="muted">Your choice vs the correct answer, plus the explanation.</p>
      <div class="row" style="margin:12px 0 6px">
        <div class="pill" style="display:flex; align-items:center; gap:10px">
          <label for="reviewFilter" class="muted" style="font-size:12px; margin:0">Show:</label>
          <select id="reviewFilter" class="btn" style="padding:8px 10px; font-weight:800">
            <option value="all">All questions</option>
            <option value="wrong">Incorrect only</option>
          </select>
        </div>
        <div class="muted small" id="reviewCount"></div>
      </div>
      <div id="reviewList"></div>

      <div class="actions">
        <button class="btn primary" id="backToResultsBtn">Back to results</button>
        <button class="btn" id="newAttemptBtn">New attempt</button>
      </div>
    </section>
  <!-- Quit confirmation modal -->
  <div id="quitConfirm" class="quit-overlay" style="display:none;">
    <div class="quit-box" role="dialog" aria-modal="true" aria-labelledby="quitTitle">
      <p class="quit-title" id="quitTitle">Are you sure?</p>
      <p class="muted">Your current progress will be lost.</p>
      <div class="quit-actions">
        <button class="btn ghost" id="quitNoBtn" type="button">No</button>
        <button class="btn primary" id="quitYesBtn" type="button">Yes, Quit</button>
      </div>
    </div>
  </div>

  <!-- Resume Attempt Modal -->
  <div id="resumeModal" class="quit-overlay" style="display:none;">
    <div class="quit-box" role="dialog" aria-modal="true" aria-labelledby="resumeTitle">
      <p class="quit-title" id="resumeTitle">Resume attempt?</p>
      <p class="muted" id="resumeInfo">‚Ä¶</p>
      <div class="quit-actions">
        <button class="btn ghost" id="resumeFreshBtn" type="button">Start fresh</button>
        <button class="btn primary" id="resumeBtn" type="button">Resume</button>
      </div>
    </div>
  </div>

  </main>

  <div class="zoomOverlay" id="zoomOverlay" aria-hidden="true">
    <img id="zoomImg" alt="Zoomed question visual" />
  </div>

<script>
// =========================================================
// REDDI2DRIVE QUIZ TEMPLATE SCRIPT
// ---------------------------------------------------------
// Sections:
// 0) Test Settings (title, slug, number of questions)
// 1) Question Bank (you replace this for each new test)
// 2) State + helpers (shuffle, storage, UI switching)
// 3) Quiz engine (render, select, submit/next)
// 4) Results + review builder
// 5) iOS/iPad scroll/pull-to-refresh protection
// =========================================================

// =========================================================
// 1) QUESTION BANK (EDIT THIS FOR EACH NEW TEST)
// ---------------------------------------------------------
// Each question object supports:
// - id: unique string (use a topic prefix like "tl-01", "sp-02", etc.)
// - category: used for the tag on the quiz + review (optional but recommended)
// - q: the question text
// - choices: array of answer strings (A/B/C/D etc.)
// - correct: index of the correct choice (0-based)
// - explain: explanation shown in the Review screen
// - image: filename of an image in the same folder as this HTML (optional)
// - largeImage / extraLargeImage: set true to increase image size (optional)
//
// TIP: Keep filenames consistent (e.g. "tl-q01.png") and put the images in the same GitHub folder.
// =========================================================
// =========================================================
// 0) TEST SETTINGS (EDIT THESE WHEN YOU COPY THIS TEMPLATE)
// =========================================================
// Keep TEST_SLUG unique per test, or scores/resume data will clash between tests.
const TEST_TITLE = "TEST TITLE";       // e.g. "Traffic Lights", "Motorways", "Signs & Markings"
const TEST_SLUG  = "test-template";    // e.g. "traffic-lights", "motorways", "signs"
// Number of questions per attempt (cannot exceed QUESTION_BANK length)
const QS_PER_ATTEMPT_DEFAULT = 10;
// =========================================================

const QUESTION_BANK = [
  {
    id: "tmpl-01",
    category: "Category ‚Äì Example",
    q: "Example question: Which option is correct?",
    choices: ["Option A","Option B","Option C","Option D"],
    correct: 1,
    explain: "Example explanation: Option B is correct because ‚Ä¶",
    image: "" // e.g. "example-q01.png"
  },
  {
    id: "tmpl-02",
    category: "Category ‚Äì Example",
    q: "Example image question: What does this sign mean?",
    choices: ["Meaning A","Meaning B","Meaning C","Meaning D"],
    correct: 0,
    explain: "Example explanation: Meaning A is correct because ‚Ä¶",
    image: "",        // e.g. "sign-q02.png"
    largeImage: true  // optional: true / false
    // extraLargeImage: true
  }
];




const el = (id) => document.getElementById(id);
const appScroll = document.getElementById("appScroll");
const startScreen = el("startScreen");
const quizScreen = el("quizScreen");
const resultsScreen = el("resultsScreen");
const reviewScreen = el("reviewScreen");

const startBtn = el("startBtn");
const shuffleBtn = el("shuffleBtn");
const resetBestBtn = el("resetBestBtn");
const bestScore = el("bestScore");
const lastScore = el("lastScore");

const catTag = el("catTag");
const counter = el("counter");
const qText = el("qText");
const answers = el("answers");
const feedback = el("feedback");
const submitBtn = el("submitBtn");
const backBtn = el("backBtn");
const quitBtn = el("quitBtn");

const quitConfirm = el("quitConfirm");
const quitYesBtn = el("quitYesBtn");
const quitNoBtn  = el("quitNoBtn");
const resumeModal = el("resumeModal");
const resumeBtn = el("resumeBtn");
const resumeFreshBtn = el("resumeFreshBtn");
const resumeInfo = el("resumeInfo");

const bar = el("bar");
const scoreMini = el("scoreMini");
scoreMini.style.display = "none";

const qImg = el("qImage");
const imgHint = el("imgHint");
const zoomOverlay = el("zoomOverlay");
const zoomImg = el("zoomImg");

const resultTitle = el("resultTitle");
const resultSub = el("resultSub");
const finalScore = el("finalScore");
const finalPercent = el("finalPercent");
const finalTime = el("finalTime");

const retryBtn = el("retryBtn");
const reviewBtn = el("reviewBtn");

const reviewList = el("reviewList");
const reviewFilter = el("reviewFilter");
const reviewCount = el("reviewCount");
const backToResultsBtn = el("backToResultsBtn");
const newAttemptBtn = el("newAttemptBtn");

const STORAGE_BEST = `r2d_${TEST_SLUG}_best`;
const STORAGE_ATTEMPT = `r2d_${TEST_SLUG}_attempt_v1`;

let attempt = [];
let idx = 0;
let score = 0;
let picked = [];
let currentSelected = []; // array of selected indices for current question
let startedAt = null;
let qsPerAttempt = QS_PER_ATTEMPT_DEFAULT;

let submitMode = 'submit'; // 'submit' or 'next'


function setSubmitButton(mode){
  submitMode = mode;
  if (mode === 'submit'){
    submitBtn.textContent = 'Submit';
    submitBtn.classList.add('primary');
    submitBtn.classList.remove('next-state');
  } else {
    submitBtn.textContent = 'Next';
    submitBtn.classList.remove('primary');
    submitBtn.classList.add('next-state');
  }
}


function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}
function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function uniqSorted(arr){
  return Array.from(new Set(arr)).sort((a,b)=>a-b);
}

function normalizeCorrect(q){
  // Returns { requiredSelections, correctIndices }
  const correctIndices = Array.isArray(q.correct) ? q.correct.slice() : [q.correct];
  const requiredSelections = Number.isFinite(q.requiredSelections) ? q.requiredSelections : correctIndices.length || 1;
  return { requiredSelections, correctIndices };
}

function sameSet(a, b){
  const aa = uniqSorted(a);
  const bb = uniqSorted(b);
  if (aa.length !== bb.length) return false;
  for (let i=0;i<aa.length;i++) if (aa[i] !== bb[i]) return false;
  return true;
}

function saveAttempt(){
  try{
    const state = {
      v: 1,
      savedAt: Date.now(),
      idx,
      score,
      picked,
      attempt,
      startedAt: startedAt ? new Date(startedAt).toISOString() : null
    };
    localStorage.setItem(STORAGE_ATTEMPT, JSON.stringify(state));
  }catch(e){
    console.warn("Could not save attempt", e);
  }
}

function loadAttempt(){
  try{
    const raw = localStorage.getItem(STORAGE_ATTEMPT);
    if (!raw) return null;
    const state = JSON.parse(raw);
    if (!state || state.v !== 1) return null;
    return state;
  }catch{
    return null;
  }
}

function clearAttempt(){
  localStorage.removeItem(STORAGE_ATTEMPT);
}

function checkForResume(){
  const state = loadAttempt();
  if (!state || !Array.isArray(state.attempt) || typeof state.idx !== "number") return false;
  if (state.idx < 0 || state.idx >= state.attempt.length) return false;

  // If it's basically a fresh attempt with no answers, only prompt if they've actually started
  const hasProgress = Array.isArray(state.picked) && state.picked.some(p => p !== null && p !== undefined);
  if (!hasProgress) return false;

  const minsAgo = Math.max(0, Math.round((Date.now() - (state.savedAt || Date.now())) / 60000));
  if (resumeInfo){
    resumeInfo.textContent = `You were on question ${state.idx + 1}. Saved ${minsAgo === 0 ? "just now" : minsAgo + " min ago"}.`;
  }
  if (resumeModal) resumeModal.style.display = "flex";
  return true;
}

if (resumeBtn){
  resumeBtn.addEventListener("click", () => {
    const state = loadAttempt();
    if (!state) return;
    // restore state
    attempt = state.attempt;
    idx = state.idx;
    score = state.score || 0;
    picked = Array.isArray(state.picked) ? state.picked : Array(attempt.length).fill(null);
    startedAt = state.startedAt ? new Date(state.startedAt) : new Date();

    if (resumeModal) resumeModal.style.display = "none";
    show(quizScreen);
    render();
  });
}

if (resumeFreshBtn){
  resumeFreshBtn.addEventListener("click", () => {
    clearAttempt();
    if (resumeModal) resumeModal.style.display = "none";
    loadStats();
    buildAttempt();
    show(quizScreen);
    render();
  });
}

// Tap outside the box closes (does not clear anything)
if (resumeModal){
  resumeModal.addEventListener("click", (e) => {
    if (e.target === resumeModal) resumeModal.style.display = "none";
  });
}
function show(screen){
  startScreen.style.display="none";
  quizScreen.style.display="none";
  resultsScreen.style.display="none";
  reviewScreen.style.display="none";
  screen.style.display="block";
  if (appScroll) appScroll.scrollTo({top:0, behavior:"smooth"});
}
function loadStats(){
  // Ensure attempt size never exceeds the bank
  qsPerAttempt = Math.min(QS_PER_ATTEMPT_DEFAULT, QUESTION_BANK.length);

  const best = Number(localStorage.getItem(STORAGE_BEST) || 0);
  const last = Number(localStorage.getItem(`r2d_${TEST_SLUG}_last`) || 0);

  bestScore.textContent = best ? `${best} / ${qsPerAttempt}` : "‚Äî";
  lastScore.textContent = last ? `${last} / ${qsPerAttempt}` : "‚Äî";
}
function buildAttempt(){
  const pool = shuffle(QUESTION_BANK);
  const selected = pool.slice(0, qsPerAttempt).map(q => {
    const mapped = q.choices.map((text, i) => ({text, originalIndex:i}));
    const shuffled = shuffle(mapped);

    const norm = normalizeCorrect(q);
    const newCorrect = norm.correctIndices.map(ci =>
      shuffled.findIndex(x => x.originalIndex === ci)
    );

    return {
      ...q,
      choices: shuffled.map(x => x.text),
      correct: newCorrect,                 // ALWAYS an array in the attempt
      requiredSelections: norm.requiredSelections
    };
  });

  attempt = selected;
  idx = 0;
  score = 0;
  picked = Array(attempt.length).fill(null);
  startedAt = new Date();
  saveAttempt();
}
function setImage(src, isLarge, isXLarge){
  // reset sizing class each time
  qImg.className = "q-image" + (isLarge ? " large" : "") + (isXLarge ? " xlarge" : "");
  if (!src){
    qImg.style.display = "none";
    imgHint.style.display = "none";
    qImg.removeAttribute("src");
    return;
  }
  qImg.style.display = "block";
  imgHint.style.display = "block";
  qImg.src = src;
}


qImg.addEventListener("click", () => {
  if (!qImg.getAttribute("src")) return;
  zoomImg.src = qImg.src;
  zoomOverlay.style.display = "flex";
  zoomOverlay.setAttribute("aria-hidden","false");
});
zoomOverlay.addEventListener("click", () => {
  zoomOverlay.style.display = "none";
  zoomOverlay.setAttribute("aria-hidden","true");
  zoomImg.removeAttribute("src");
});

function render(){
  const q = attempt[idx];
  catTag.textContent = q.category || "Category";
  counter.textContent = `Question ${idx+1}`;
  qText.textContent = q.q;

  // Hide running score so users don't know results until the end
  scoreMini.textContent = "";

  // Progress shows where you are in the quiz (not your score)
  bar.style.width = `${Math.round((idx/attempt.length)*100)}%`;

  setImage(q.image, !!q.largeImage, !!q.extraLargeImage);

  answers.innerHTML = "";
  feedback.style.display = "none"; // no per-question feedback
  feedback.className = "feedback";

  currentSelected = [];
  setSubmitButton('submit');
  // Multi-answer support: enable submit only when required selections are made
  const required = q.requiredSelections || (Array.isArray(q.correct) ? q.correct.length : 1) || 1;
  submitBtn.disabled = true;

  q.choices.forEach((choiceText, i) => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "option";
    b.textContent = choiceText;
    b.addEventListener("click", () => selectOption(i));
    answers.appendChild(b);
  });

  // If this question was already submitted (e.g. user pressed Back), show it locked
  if (picked[idx] !== null && picked[idx] !== undefined){
    const chosen = picked[idx].choiceIndices;
    lockSubmitted(chosen);
    setSubmitButton('next');
    submitBtn.disabled = false;
    bar.style.width = `${Math.round(((idx+1)/attempt.length)*100)}%`;
  }
}

function selectOption(selectedIndex){
  // allow changing mind until submitted
  if (picked[idx] !== null && picked[idx] !== undefined) return;

  const q = attempt[idx];
  const required = q.requiredSelections || (Array.isArray(q.correct) ? q.correct.length : 1) || 1;

  // toggle selection
  const pos = currentSelected.indexOf(selectedIndex);
  if (pos >= 0){
    currentSelected.splice(pos, 1);
  } else {
    if (currentSelected.length >= required) return; // cap selections
    currentSelected.push(selectedIndex);
  }

  // update UI
  [...answers.querySelectorAll('button.option')].forEach((btn, i) => {
    btn.classList.toggle('selected', currentSelected.includes(i));
  });

  submitBtn.disabled = (currentSelected.length !== required);
}

function lockSubmitted(selectedIndices){
  const sel = Array.isArray(selectedIndices) ? selectedIndices : [selectedIndices];
  [...answers.querySelectorAll('button.option')].forEach((btn, i) => {
    btn.disabled = true;
    btn.classList.toggle('selected', sel.includes(i));
  });
}

function submitCurrent(){
  const q = attempt[idx];
  const required = q.requiredSelections || (Array.isArray(q.correct) ? q.correct.length : 1) || 1;
  if (currentSelected.length !== required) return;

  // lock in answer for this question
  picked[idx] = { choiceIndices: currentSelected.slice() };

  lockSubmitted(currentSelected);
  setSubmitButton('next');
  submitBtn.disabled = false;
  bar.style.width = `${Math.round(((idx+1)/attempt.length)*100)}%`;
  saveAttempt();
}

function finish(){
  const total = attempt.length;

  // Calculate score only at the end (no feedback during the quiz)
  score = picked.reduce((s, p, i) => {
    if (!p) return s;
    const selected = p.choiceIndices || [];
    const correct = Array.isArray(attempt[i].correct) ? attempt[i].correct : [attempt[i].correct];
    return s + (sameSet(selected, correct) ? 1 : 0);
  }, 0);

  const pct = Math.round((score/total)*100);
  const elapsedMs = new Date() - startedAt;
  const mins = Math.floor(elapsedMs/60000);
  const secs = Math.floor((elapsedMs%60000)/1000);
  const timeStr = `${mins}m ${secs}s`;

  finalScore.textContent = `${score} / ${total}`;
  finalPercent.textContent = `${pct}%`;
  finalTime.textContent = timeStr;

  let title, sub;
  if (pct >= 90){
    title = "Excellent knowledge üí™";
    sub = "Keep it sharp by practising in real situations and revisiting any tricky areas.";
  } else if (pct >= 70){
    title = "Good work ‚Äî a few gaps to tighten up ‚úÖ";
    sub = "Review the questions you missed and focus on the rules that caught you out.";
  } else if (pct >= 50){
    title = "Not bad ‚Äî let‚Äôs build consistency üîÅ";
    sub = "Slow down, read each question carefully, and learn the patterns behind the correct answers.";
  } else {
    title = "Let‚Äôs nail the foundations üß±";
    sub = "Use the review explanations, then try again. Consistency beats guessing.";
  }
  resultTitle.textContent = title;
  resultSub.textContent = sub;

  localStorage.setItem(`r2d_${TEST_SLUG}_last`, String(score));

  const best = Number(localStorage.getItem(STORAGE_BEST) || 0);
  if (score > best){
    localStorage.setItem(STORAGE_BEST, String(score));
  }
  loadStats();

  clearAttempt();

  show(resultsScreen);
}

function buildReview(filter = 'all'){
  reviewList.innerHTML = "";
  let shown = 0;

  attempt.forEach((q, i) => {    const p = picked[i];
    const youArr = p ? (p.choiceIndices || []) : [];
    const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
    const you = youArr.length ? youArr.map(ix => q.choices[ix]).join(" / ") : "‚Äî";
    const correct = correctArr.map(ix => q.choices[ix]).join(" / ");
    const ok = p ? sameSet(youArr, correctArr) : false;

    if (filter === "wrong" && ok) return;

    shown += 1;

    const div = document.createElement("div");
    div.className = "reviewItem";
    div.innerHTML = `
      <div class="row">
        <div>
          <span class="tag">${escapeHtml(q.category || "Category")}</span>
          <strong>${escapeHtml(q.q)}</strong>
        </div>
        </div>
      <div class="result ${ok ? "ok" : "bad"}">${ok ? "‚úì" : "‚úï"}</div>
      ${q.image ? `<img class="q-image review-image${q.largeImage ? " large" : ""}${q.extraLargeImage ? " xlarge" : ""}" alt="Question visual" src="${escapeHtml(q.image)}">` : ""}
      <div class="small" style="margin-top:8px">
        <div><span class="muted">You chose:</span> <strong>${escapeHtml(you)}</strong></div>
        <div><span class="muted">Correct:</span> <strong>${escapeHtml(correct)}</strong></div>
      </div>
      <div class="hint">${escapeHtml(q.explain || "")}</div>
    `;
    reviewList.appendChild(div);
  });

  if (reviewCount) reviewCount.textContent = `${shown} shown`;
}

startBtn.addEventListener("click", () => {
  loadStats();
  if (checkForResume()) return;
  buildAttempt();
  show(quizScreen);
  render();
});
shuffleBtn.addEventListener("click", () => {
  const temp = shuffle(QUESTION_BANK);
  QUESTION_BANK.length = 0;
  temp.forEach(x => QUESTION_BANK.push(x));
  loadStats();
});
resetBestBtn.addEventListener("click", () => {
  localStorage.removeItem(STORAGE_BEST);
  loadStats();
});


function goNext(){
  // must submit before moving on
  if (!picked[idx]) return;

  if (idx < attempt.length - 1){
    idx += 1;
    saveAttempt();
    render();
  } else {
    finish();
  }
}

submitBtn.addEventListener("click", () => {
  if (submitMode === "submit"){
    submitCurrent();
  } else {
    goNext();
  }
});

backBtn.addEventListener("click", () => {
  if (idx > 0){
    idx -= 1;
    render();
  } else {
    show(startScreen);
  }
});
quitBtn.addEventListener("click", () => {
  if (!quitConfirm) return show(startScreen);
  quitConfirm.style.display = "flex";
});

if (quitNoBtn){
  quitNoBtn.addEventListener("click", () => {
    quitConfirm.style.display = "none";
  });
}

if (quitYesBtn){
  quitYesBtn.addEventListener("click", () => {
    quitConfirm.style.display = "none";
    clearAttempt();
    show(startScreen);
  });
}

// Tap outside the box closes (same as "No")
if (quitConfirm){
  quitConfirm.addEventListener("click", (e) => {
    if (e.target === quitConfirm) quitConfirm.style.display = "none";
  });
}

retryBtn.addEventListener("click", () => {
  buildAttempt();
  show(quizScreen);
  render();
});
reviewBtn.addEventListener("click", () => {
  const f = reviewFilter ? reviewFilter.value : "all";
  buildReview(f);
  show(reviewScreen);
});

if (reviewFilter){
  reviewFilter.addEventListener("change", () => buildReview(reviewFilter.value));
}
backToResultsBtn.addEventListener("click", () => show(resultsScreen));
newAttemptBtn.addEventListener("click", () => {
  buildAttempt();
  show(quizScreen);
  render();
});

// =========================================================
// 2) UI TITLE (AUTO)
// ---------------------------------------------------------
// Keeps the page header title in sync with TEST_TITLE.
// =========================================================
const titleEl = document.getElementById("testTitleText");
if (titleEl) titleEl.textContent = TEST_TITLE;

loadStats();
show(startScreen);
checkForResume();

(() => {
  const scroller = document.getElementById("appScroll");
  if (!scroller) return;

  let startY = 0;

  scroller.addEventListener("touchstart", (e) => {
    startY = e.touches[0].clientY;
  }, { passive: true });

  scroller.addEventListener("touchmove", (e) => {
    const y = e.touches[0].clientY;
    const pullingDown = y > startY;

    if (scroller.scrollTop <= 0 && pullingDown) {
      e.preventDefault();
    }
  }, { passive: false });
})();

  // --- Fix iPad landscape viewport + prevent pull-to-refresh reliably ---
(() => {
  const scroller = document.getElementById("appScroll");
  if (!scroller) return;

  function setScrollerHeight(){
    const h = (window.visualViewport && window.visualViewport.height)
      ? Math.round(window.visualViewport.height)
      : window.innerHeight;
    scroller.style.height = h + "px";
  }

  setScrollerHeight();
  window.addEventListener("resize", setScrollerHeight);
  if (window.visualViewport) window.visualViewport.addEventListener("resize", setScrollerHeight);

  let startY = 0;
  scroller.addEventListener("touchstart", (e) => {
    startY = e.touches[0].clientY;
  }, { passive: true });

  scroller.addEventListener("touchmove", (e) => {
    const y = e.touches[0].clientY;
    const pullingDown = y > startY;
    if (scroller.scrollTop <= 0 && pullingDown) e.preventDefault();
  }, { passive: false });
})();

</script>
  </div>
</body>
</html>
